#!/usr/bin/env python3
"""
Script para migrar o sistema de perfil Ãºnico para perfis mÃºltiplos.
Execute com: python scripts/migrate_to_multiple_profiles.py
"""

import asyncio
import sys
import os
from datetime import datetime
import dotenv

# Adiciona o diretÃ³rio raiz ao path
dotenv.load_dotenv(dotenv_path=os.path.join(os.path.dirname(__file__), '..', '.env'))

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))


import asyncpg
from app.core.config import settings

async def create_multiple_profiles_tables(conn: asyncpg.Connection):
    """Cria as tabelas necessÃ¡rias para o sistema de perfis mÃºltiplos"""
    
    print("ğŸ”§ Criando tabela usuario_perfil...")
    
    # Cria a tabela usuario_perfil
    await conn.execute("""
        CREATE TABLE IF NOT EXISTS "usuario_perfil" (
            "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            "usuario_id" int NOT NULL,
            "perfil_id" int NOT NULL,
            "ativo" boolean NOT NULL DEFAULT TRUE,
            "concedido_por_usuario_id" int,
            "data_concessao" timestamp DEFAULT (now()),
            "observacoes" text,
            FOREIGN KEY ("usuario_id") REFERENCES "usuario" ("id"),
            FOREIGN KEY ("perfil_id") REFERENCES "perfil" ("id"),
            FOREIGN KEY ("concedido_por_usuario_id") REFERENCES "usuario" ("id"),
            UNIQUE("usuario_id", "perfil_id")
        );
    """)
    
    # Cria Ã­ndices
    await conn.execute("""
        CREATE INDEX IF NOT EXISTS idx_usuario_perfil_usuario_id 
        ON usuario_perfil(usuario_id) WHERE ativo = TRUE;
    """)
    
    await conn.execute("""
        CREATE INDEX IF NOT EXISTS idx_usuario_perfil_perfil_id 
        ON usuario_perfil(perfil_id) WHERE ativo = TRUE;
    """)
    
    # Cria view
    await conn.execute("""
        CREATE OR REPLACE VIEW v_usuario_perfis AS
        SELECT 
            u.id as usuario_id,
            u.nome as usuario_nome,
            u.email,
            array_agg(p.nome ORDER BY p.nome) as perfis,
            array_agg(p.id ORDER BY p.nome) as perfil_ids,
            string_agg(p.nome, ', ' ORDER BY p.nome) as perfis_texto
        FROM usuario u
        LEFT JOIN usuario_perfil up ON u.id = up.usuario_id AND up.ativo = TRUE
        LEFT JOIN perfil p ON up.perfil_id = p.id AND p.ativo = TRUE
        WHERE u.ativo = TRUE
        GROUP BY u.id, u.nome, u.email;
    """)
    
    print("âœ… Tabelas criadas com sucesso!")

async def migrate_existing_users(conn: asyncpg.Connection):
    """Migra usuÃ¡rios existentes do sistema de perfil Ãºnico"""
    
    print("ğŸ“‹ Migrando usuÃ¡rios existentes...")
    
    # Busca admin para usar como "concedido_por"
    admin_id = await conn.fetchval("""
        SELECT u.id FROM usuario u 
        JOIN perfil p ON u.perfil_id = p.id 
        WHERE p.nome = 'Administrador' AND u.ativo = TRUE 
        LIMIT 1
    """)
    
    if not admin_id:
        print("âš ï¸ Nenhum administrador encontrado, usando ID 1 como padrÃ£o")
        admin_id = 1
    
    # Verifica se jÃ¡ existe migraÃ§Ã£o
    existing_count = await conn.fetchval("SELECT COUNT(*) FROM usuario_perfil")
    
    if existing_count > 0:
        print(f"âš ï¸ JÃ¡ existem {existing_count} registros na tabela usuario_perfil")
        resposta = input("Deseja continuar mesmo assim? (s/N): ").strip().lower()
        if resposta != 's':
            print("âŒ MigraÃ§Ã£o cancelada")
            return
    
    # Migra usuÃ¡rios
    users_to_migrate = await conn.fetch("""
        SELECT u.id, u.nome, u.perfil_id, p.nome as perfil_nome
        FROM usuario u
        LEFT JOIN perfil p ON u.perfil_id = p.id
        WHERE u.ativo = TRUE AND u.perfil_id IS NOT NULL
    """)
    
    migrated_count = 0
    
    for user in users_to_migrate:
        try:
            # Verifica se jÃ¡ foi migrado
            existing = await conn.fetchval("""
                SELECT 1 FROM usuario_perfil 
                WHERE usuario_id = $1 AND perfil_id = $2
            """, user['id'], user['perfil_id'])
            
            if existing:
                print(f"â­ï¸ UsuÃ¡rio {user['nome']} jÃ¡ migrado")
                continue
            
            # Insere na nova tabela
            await conn.execute("""
                INSERT INTO usuario_perfil (usuario_id, perfil_id, concedido_por_usuario_id, observacoes)
                VALUES ($1, $2, $3, $4)
            """, user['id'], user['perfil_id'], admin_id, 'MigraÃ§Ã£o automÃ¡tica do sistema anterior')
            
            migrated_count += 1
            print(f"âœ… Migrado: {user['nome']} â†’ {user['perfil_nome']}")
            
        except Exception as e:
            print(f"âŒ Erro ao migrar {user['nome']}: {e}")
    
    print(f"ğŸ“Š Total migrado: {migrated_count} usuÃ¡rios")

async def validate_migration(conn: asyncpg.Connection):
    """Valida se a migraÃ§Ã£o foi bem-sucedida"""
    
    print("\nğŸ” Validando migraÃ§Ã£o...")
    
    # Compara contagens
    users_with_old_profile = await conn.fetchval("""
        SELECT COUNT(*) FROM usuario 
        WHERE ativo = TRUE AND perfil_id IS NOT NULL
    """)
    
    users_with_new_profiles = await conn.fetchval("""
        SELECT COUNT(DISTINCT usuario_id) FROM usuario_perfil 
        WHERE ativo = TRUE
    """)
    
    print(f"ğŸ“Š UsuÃ¡rios no sistema antigo: {users_with_old_profile}")
    print(f"ğŸ“Š UsuÃ¡rios no sistema novo: {users_with_new_profiles}")
    
    if users_with_old_profile == users_with_new_profiles:
        print("âœ… MigraÃ§Ã£o validada com sucesso!")
    else:
        print("âš ï¸ DivergÃªncia encontrada na migraÃ§Ã£o")
    
    # Mostra alguns exemplos
    print("\nğŸ‘¥ Exemplos de usuÃ¡rios migrados:")
    examples = await conn.fetch("""
        SELECT usuario_nome, perfis_texto 
        FROM v_usuario_perfis 
        WHERE perfis_texto IS NOT NULL
        LIMIT 5
    """)
    
    for example in examples:
        print(f"  â€¢ {example['usuario_nome']}: {example['perfis_texto']}")

async def create_example_multi_profile_user(conn: asyncpg.Connection):
    """Cria um usuÃ¡rio de exemplo com mÃºltiplos perfis"""
    
    print("\nğŸ‘¤ Criando usuÃ¡rio de exemplo com mÃºltiplos perfis...")
    
    # Busca IDs dos perfis
    perfil_gestor = await conn.fetchval("SELECT id FROM perfil WHERE nome = 'Gestor'")
    perfil_fiscal = await conn.fetchval("SELECT id FROM perfil WHERE nome = 'Fiscal'")
    admin_id = 1
    
    if not (perfil_gestor and perfil_fiscal):
        print("âš ï¸ Perfis Gestor/Fiscal nÃ£o encontrados, pulando exemplo")
        return
    
    # Busca ou cria usuÃ¡rio exemplo
    usuario_exemplo = await conn.fetchrow("""
        SELECT id FROM usuario WHERE email = 'exemplo.multiperfil@sigescon.com'
    """)
    
    if not usuario_exemplo:
        from app.core.security import get_password_hash
        senha_hash = get_password_hash("senha123")
        
        usuario_id = await conn.fetchval("""
            INSERT INTO usuario (nome, email, cpf, senha_hash, perfil_id)
            VALUES ($1, $2, $3, $4, $5)
            RETURNING id
        """, "JoÃ£o Multi Perfil", "exemplo.multiperfil@sigescon.com", "11122233344", senha_hash, perfil_gestor)
    else:
        usuario_id = usuario_exemplo['id']
    
    # Adiciona mÃºltiplos perfis
    for perfil_id, perfil_nome in [(perfil_gestor, "Gestor"), (perfil_fiscal, "Fiscal")]:
        try:
            await conn.execute("""
                INSERT INTO usuario_perfil (usuario_id, perfil_id, concedido_por_usuario_id, observacoes)
                VALUES ($1, $2, $3, $4)
                ON CONFLICT (usuario_id, perfil_id) DO NOTHING
            """, usuario_id, perfil_id, admin_id, f"Exemplo de usuÃ¡rio com perfil {perfil_nome}")
            
            print(f"âœ… Perfil {perfil_nome} adicionado ao usuÃ¡rio exemplo")
        except Exception as e:
            print(f"âš ï¸ Erro ao adicionar perfil {perfil_nome}: {e}")

async def show_migration_summary(conn: asyncpg.Connection):
    """Mostra resumo final da migraÃ§Ã£o"""
    
    print("\nğŸ“ˆ RESUMO DA MIGRAÃ‡ÃƒO")
    print("=" * 50)
    
    # Statistics
    total_users = await conn.fetchval("SELECT COUNT(*) FROM usuario WHERE ativo = TRUE")
    users_with_profiles = await conn.fetchval("SELECT COUNT(DISTINCT usuario_id) FROM usuario_perfil WHERE ativo = TRUE")
    total_profile_assignments = await conn.fetchval("SELECT COUNT(*) FROM usuario_perfil WHERE ativo = TRUE")
    
    print(f"ğŸ‘¥ Total de usuÃ¡rios ativos: {total_users}")
    print(f"ğŸ­ UsuÃ¡rios com perfis atribuÃ­dos: {users_with_profiles}")
    print(f"ğŸ“‹ Total de atribuiÃ§Ãµes de perfil: {total_profile_assignments}")
    
    # Profile distribution
    print("\nğŸ“Š DISTRIBUIÃ‡ÃƒO POR PERFIL:")
    profile_stats = await conn.fetch("""
        SELECT p.nome, COUNT(up.usuario_id) as total_usuarios
        FROM perfil p
        LEFT JOIN usuario_perfil up ON p.id = up.perfil_id AND up.ativo = TRUE
        WHERE p.ativo = TRUE
        GROUP BY p.id, p.nome
        ORDER BY total_usuarios DESC
    """)
    
    for stat in profile_stats:
        print(f"  â€¢ {stat['nome']}: {stat['total_usuarios']} usuÃ¡rios")
    
    # Multi-profile users
    multi_profile_users = await conn.fetch("""
        SELECT usuario_nome, perfis_texto
        FROM v_usuario_perfis
        WHERE array_length(perfis, 1) > 1
        ORDER BY usuario_nome
    """)
    
    if multi_profile_users:
        print(f"\nğŸ­ USUÃRIOS COM MÃšLTIPLOS PERFIS ({len(multi_profile_users)}):")
        for user in multi_profile_users:
            print(f"  â€¢ {user['usuario_nome']}: {user['perfis_texto']}")
    else:
        print("\nğŸ­ Nenhum usuÃ¡rio com mÃºltiplos perfis encontrado")
    
    print("\nâœ… MigraÃ§Ã£o concluÃ­da com sucesso!")
    print("\nğŸ’¡ PRÃ“XIMOS PASSOS:")
    print("1. Teste as funcionalidades de perfis mÃºltiplos")
    print("2. Adicione perfis adicionais aos usuÃ¡rios conforme necessÃ¡rio")
    print("3. Use os endpoints /api/v1/usuarios/{id}/perfis para gerenciar")
    print("4. Considere remover a coluna 'perfil_id' da tabela usuario apÃ³s validaÃ§Ã£o completa")

async def main():
    """Executa a migraÃ§Ã£o completa"""
    
    print("ğŸš€ SIGESCON - MigraÃ§Ã£o para Sistema de Perfis MÃºltiplos")
    print("=" * 60)
    print(f"ğŸ“… Data: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
    print()
    
    try:
        # Conecta ao banco
        conn = await asyncpg.connect(settings.DATABASE_URL)
        print("âœ… Conectado ao banco de dados")
        
        # Executa migraÃ§Ã£o
        await create_multiple_profiles_tables(conn)
        await migrate_existing_users(conn)
        await validate_migration(conn)
        await create_example_multi_profile_user(conn)
        await show_migration_summary(conn)
        
    except Exception as e:
        print(f"âŒ Erro durante a migraÃ§Ã£o: {e}")
        return 1
    
    finally:
        if 'conn' in locals():
            await conn.close()
            print("\nğŸ”Œ ConexÃ£o com banco encerrada")
    
    return 0

if __name__ == "__main__":
    exit_code = asyncio.run(main())